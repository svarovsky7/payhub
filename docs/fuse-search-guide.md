# Умный поиск с Fuse.js

## Библиотека
**Fuse.js v7.0.0** - легковесная библиотека для fuzzy search (нечеткий поиск) на стороне клиента.
- Размер: ~12KB gzipped
- Документация: https://fusejs.io/

## Текущее состояние
- **Загружено**: 5000 записей (~3.6% от 138K в БД)
- **Threshold**: 0.3 (баланс точности и гибкости)
- **Поиск**: По одному или нескольким словам
- **Скорость**: Мгновенная (клиентский поиск)

## Возможности

### 1. Fuzzy поиск (нечеткий поиск)
Находит результаты даже при опечатках:
- Ввод: `бетон м400` → Найдет: "Бетон М-400", "М400 Бетон"
- Ввод: `армтура` (опечатка) → Найдет: "Арматура"
- Ввод: `гвзди` (опечатка) → Найдет: "Гвозди"

### 2. Частичное совпадение
Ищет по части слова:
- Ввод: `бет` → Найдет: "Бетон", "Бетономешалка"
- Ввод: `12` → Найдет: "Арматура 12мм", "Труба 120мм"

### 3. Мульти-словный поиск (улучшенный)
При вводе нескольких слов работает специальный алгоритм:
1. Первое слово ищется с помощью Fuse.js (fuzzy match)
2. Остальные слова фильтруются точным вхождением

**Примеры:**
- Ввод: `арматура 12` → Найдет: "Арматура d12", "Арматура 12мм"
- Ввод: `бетон м400` → Найдет: "Бетон М-400 (В30)"
- Ввод: `гвозди 50 мм` → Найдет: "Гвозди строительные 50мм"

Преимущество: Первое слово может иметь опечатки, остальные - точное вхождение.

### 4. Поиск в любом месте строки
```typescript
ignoreLocation: true
```
Ищет по всей строке, а не только в начале:
- Ввод: `м400` → Найдет: "Бетон М-400 (В30)"

### 5. Ранжирование результатов
```typescript
includeScore: true
shouldSort: true
```
Лучшие совпадения показываются первыми.

## Конфигурация

### Текущие настройки в MaterialRequestFormModal

```typescript
new Fuse(allNomenclature, {
  keys: [
    { name: 'name', weight: 1.0 }  // Поиск только по названию
  ],
  threshold: 0.3,         // Чувствительность (снижена для лучшего match)
  distance: 150,          // Макс. расстояние для fuzzy match
  minMatchCharLength: 1,  // Разрешен поиск с 1 символа
  ignoreLocation: true,   // Поиск в любом месте строки
  includeScore: true,     // Включить оценку совпадения
  shouldSort: true        // Сортировать по релевантности
})
```

**Загрузка данных**: 5000 записей при открытии модала (покрытие ~3.6% от БД)

### Настройка чувствительности

**threshold** (порог совпадения):
- `0.0` - только точные совпадения
- `0.2` - строгий поиск (мало ложных результатов)
- `0.4` - **текущее** - баланс точности и гибкости
- `0.6` - мягкий поиск (больше результатов)
- `1.0` - найдет всё

### Расширенный синтаксис поиска

С `useExtendedSearch: true` доступны:

| Синтаксис | Описание | Пример |
|-----------|----------|--------|
| `'бетон` | Точное совпадение начала | `'бет` → "Бетон М-400" |
| `!м400` | Исключение | `бетон !м400` → все бетоны кроме М-400 |
| `^бетон` | Начинается с | `^бет` → "Бетон", но не "Раствор бетонный" |
| `бетон$` | Заканчивается на | `м3$` → "Бетон (м3)" |
| `'м-400 \| 'м400` | ИЛИ | Найдет "М-400" или "М400" |

## Примеры использования

### Простой поиск
```typescript
const results = fuse.search('бетон м400')
// Вернет массив объектов с полями item и score
```

### Расширенный поиск
```typescript
// Все бетоны, но не М-200
const results = fuse.search('бетон !м-200')

// Начинается с "Арматура"
const results = fuse.search('^арматура')

// Заканчивается на "(м3)"
const results = fuse.search('м3$')
```

### Получение результатов
```typescript
const results = fuse.search('бетон')
results.forEach(result => {
  console.log(result.item.name)  // Название
  console.log(result.score)      // Оценка совпадения (0-1)
})
```

## Производительность

- **Загрузка**: 5000 записей при открытии модала (~3.6% покрытие БД)
- **Поиск**: Мгновенный (все вычисления на клиенте)
- **Результаты**: Топ-200 лучших совпадений
- **Память**: ~3-5MB для 5000 записей
- **Время загрузки**: ~500-800ms при первом открытии

## Ограничения

- Работает только с загруженными данными (5000 из 138K записей)
- Покрытие: ~3.6% от всей БД
- Для поиска по всей БД нужен серверный Full-Text Search
- Не индексирует данные (каждый поиск сканирует все 5000 записей)
- При росте БД до 500K+ может потребоваться переход на серверное решение

## Альтернативы

1. **PostgreSQL Full-Text Search** - серверный, для больших объемов
2. **Lunr.js** - клиентский, с индексацией
3. **Elasticsearch** - серверный, enterprise решение
4. **MeiliSearch** - серверный, быстрый и современный

Для текущих требований Fuse.js - оптимальный выбор.
